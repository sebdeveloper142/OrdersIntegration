{
	"$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
	"contentVersion": "1.0.0.0",
	"parameters": {
		"apimServiceName": {
			"type": "string"
		},
		"serviceUrl": {
			"type": "object"
		}
	},
	"resources": [
		{
			"apiVersion": "2021-08-01",
			"type": "Microsoft.ApiManagement/service/apis",
			"name": "[concat(parameters('apimServiceName'), '/utility-api-messaging')]",
			"dependsOn": [],
			"properties": {
				"description": "This serves as a reley between cliend and service bus",
				"authenticationSettings": {
					"subscriptionKeyRequired": false
				},
				"subscriptionKeyParameterNames": {
					"header": "Ocp-Apim-Subscription-Key",
					"query": "subscription-key"
				},
				"apiRevision": "1",
				"isCurrent": true,
				"subscriptionRequired": true,
				"displayName": "Utility - API Messaging",
				"serviceUrl": "[parameters('serviceUrl').utilityapimessaging]",
				"path": "",
				"protocols": [
					"https"
				]
			}
		},
		{
			"apiVersion": "2021-08-01",
			"type": "Microsoft.ApiManagement/service/products/apis",
			"name": "[concat(parameters('apimServiceName'), '/starter/utility-api-messaging')]",
			"dependsOn": [
				"[resourceId('Microsoft.ApiManagement/service/apis', parameters('apimServiceName'), 'utility-api-messaging')]"
			],
			"properties": {
				"displayName": "Starter",
				"description": "Subscribers will be able to run 5 calls/minute up to a maximum of 100 calls/week.",
				"subscriptionRequired": true,
				"approvalRequired": false,
				"state": "published"
			}
		},
		{
			"apiVersion": "2021-08-01",
			"type": "Microsoft.ApiManagement/service/apis/operations",
			"name": "[concat(parameters('apimServiceName'), '/utility-api-messaging/service-bus-get-message')]",
			"dependsOn": [
				"[resourceId('Microsoft.ApiManagement/service/apis', parameters('apimServiceName'), 'utility-api-messaging')]"
			],
			"properties": {
				"displayName": "Service Bus - Get message",
				"method": "DELETE",
				"urlTemplate": "/servicebus/out",
				"description": "Get message from queue",
				"templateParameters": [],
				"responses": []
			}
		},
		{
			"apiVersion": "2021-08-01",
			"type": "Microsoft.ApiManagement/service/apis/operations",
			"name": "[concat(parameters('apimServiceName'), '/utility-api-messaging/service-bus-send-message')]",
			"dependsOn": [
				"[resourceId('Microsoft.ApiManagement/service/apis', parameters('apimServiceName'), 'utility-api-messaging')]"
			],
			"properties": {
				"displayName": "Service Bus - Send message",
				"method": "POST",
				"urlTemplate": "/servicebus/in",
				"description": "",
				"templateParameters": [],
				"responses": []
			}
		},
		{
			"apiVersion": "2021-08-01",
			"type": "Microsoft.ApiManagement/service/apis/operations/policies",
			"name": "[concat(parameters('apimServiceName'), '/utility-api-messaging/service-bus-get-message/policy')]",
			"dependsOn": [
				"[resourceId('Microsoft.ApiManagement/service/apis/operations', parameters('apimServiceName'), 'utility-api-messaging', 'service-bus-get-message')]"
			],
			"properties": {
				"policyContent": "<policies>    <inbound>        <base />        <set-method>DELETE</set-method>        <set-backend-service base-url='https://B2BMessages.servicebus.windows.net/orders_out/messages/head' />        <rewrite-uri template='/' />        <set-header name='Content-Type' exists-action='override'>            <value>vnd.microsoft.servicebus.yml</value>        </set-header>        <set-header name='Authorization' exists-action='override'>            <value>{{RootManageSharedAccessKey}}</value>        </set-header>    </inbound>    <backend>        <base />    </backend>    <outbound>        <base />    </outbound>    <on-error>        <base />    </on-error> </policies>"
			}
		},
		{
			"apiVersion": "2021-08-01",
			"type": "Microsoft.ApiManagement/service/apis/operations/policies",
			"name": "[concat(parameters('apimServiceName'), '/utility-api-messaging/service-bus-send-message/policy')]",
			"dependsOn": [
				"[resourceId('Microsoft.ApiManagement/service/apis/operations', parameters('apimServiceName'), 'utility-api-messaging', 'service-bus-send-message')]"
			],
			"properties": {
                "policyContent": "[concat('<!--\r\n    IMPORTANT:\r\n    - Policy elements can appear only within the <inbound>, <outbound>, <backend> section elements.\r\n    - Only the <forward-request> policy element can appear within the <backend> section element.\r\n    - To apply a policy to the incoming request (before it is forwarded to the backend service), place a corresponding policy element within the <inbound> section element.\r\n    - To apply a policy to the outgoing response (before it is sent back to the caller), place a corresponding policy element within the <outbound> section element.\r\n    - To add a policy position the cursor at the desired insertion point and click on the round button associated with the policy.\r\n    - To remove a policy, delete the corresponding policy statement from the policy document.\r\n    - Position the <base> element within a section element to inherit all policies from the corresponding section element in the enclosing scope.\r\n    - Remove the <base> element to prevent inheriting policies from the corresponding section element in the enclosing scope.\r\n    - Policies are applied in the order of their appearance, from the top down.\r\n-->\r\n<policies>\r\n  <inbound>\r\n    <base />\r\n    <set-backend-service base-url=\"https://api.apis.guru/v2/\" />\r\n    <rewrite-uri template=\"/metrics.json\" />\r\n  </inbound>\r\n  <backend>\r\n    <base />\r\n  </backend>\r\n  <outbound>\r\n    <base />\r\n  </outbound>\r\n  <on-error>\r\n    <base />\r\n  </on-error>\r\n</policies>')]"
            }
		}
	]
}
